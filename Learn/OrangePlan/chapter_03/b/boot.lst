     1                                           ;ļc13_mbr0.asm
     2                                           ;ļ˵Ӳ 
     3                                  %include "pm.inc"
     4                              <1> 
     5                              <1> 
     6                              <1> ; 描述符图示
     7                              <1> 
     8                              <1> ; 图示一
     9                              <1> ;
    10                              <1> ;  ------ ┏━━┳━━┓高地址
    11                              <1> ;         ┃ 7  ┃ 段 ┃
    12                              <1> ;         ┣━━┫    ┃
    13                              <1> ;                  基
    14                              <1> ;  字节 7 ┆    ┆    ┆
    15                              <1> ;                  址
    16                              <1> ;         ┣━━┫ ② ┃
    17                              <1> ;         ┃ 0  ┃    ┃
    18                              <1> ;  ------ ┣━━╋━━┫
    19                              <1> ;         ┃ 7  ┃ G  ┃
    20                              <1> ;         ┣━━╉──┨
    21                              <1> ;         ┃ 6  ┃ D  ┃
    22                              <1> ;         ┣━━╉──┨
    23                              <1> ;         ┃ 5  ┃ 0  ┃
    24                              <1> ;         ┣━━╉──┨
    25                              <1> ;         ┃ 4  ┃ AVL┃
    26                              <1> ;  字节 6 ┣━━╉──┨
    27                              <1> ;         ┃ 3  ┃    ┃
    28                              <1> ;         ┣━━┫ 段 ┃
    29                              <1> ;         ┃ 2  ┃ 界 ┃
    30                              <1> ;         ┣━━┫ 限 ┃
    31                              <1> ;         ┃ 1  ┃    ┃
    32                              <1> ;         ┣━━┫ ② ┃
    33                              <1> ;         ┃ 0  ┃    ┃
    34                              <1> ;  ------ ┣━━╋━━┫
    35                              <1> ;         ┃ 7  ┃ P  ┃
    36                              <1> ;         ┣━━╉──┨
    37                              <1> ;         ┃ 6  ┃    ┃
    38                              <1> ;         ┣━━┫ DPL┃
    39                              <1> ;         ┃ 5  ┃    ┃
    40                              <1> ;         ┣━━╉──┨
    41                              <1> ;         ┃ 4  ┃ S  ┃
    42                              <1> ;  字节 5 ┣━━╉──┨
    43                              <1> ;         ┃ 3  ┃    ┃
    44                              <1> ;         ┣━━┫ T  ┃
    45                              <1> ;         ┃ 2  ┃ Y  ┃
    46                              <1> ;         ┣━━┫ P  ┃
    47                              <1> ;         ┃ 1  ┃ E  ┃
    48                              <1> ;         ┣━━┫    ┃
    49                              <1> ;         ┃ 0  ┃    ┃
    50                              <1> ;  ------ ┣━━╋━━┫
    51                              <1> ;         ┃ 23 ┃    ┃
    52                              <1> ;         ┣━━┫    ┃
    53                              <1> ;         ┃ 22 ┃    ┃
    54                              <1> ;         ┣━━┫ 段 ┃
    55                              <1> ;
    56                              <1> ;   字节  ┆    ┆ 基 ┆
    57                              <1> ; 2, 3, 4
    58                              <1> ;         ┣━━┫ 址 ┃
    59                              <1> ;         ┃ 1  ┃ ① ┃
    60                              <1> ;         ┣━━┫    ┃
    61                              <1> ;         ┃ 0  ┃    ┃
    62                              <1> ;  ------ ┣━━╋━━┫
    63                              <1> ;         ┃ 15 ┃    ┃
    64                              <1> ;         ┣━━┫    ┃
    65                              <1> ;         ┃ 14 ┃    ┃
    66                              <1> ;         ┣━━┫ 段 ┃
    67                              <1> ;
    68                              <1> ; 字节 0,1┆    ┆ 界 ┆
    69                              <1> ;
    70                              <1> ;         ┣━━┫ 限 ┃
    71                              <1> ;         ┃ 1  ┃ ① ┃
    72                              <1> ;         ┣━━┫    ┃
    73                              <1> ;         ┃ 0  ┃    ┃
    74                              <1> ;  ------ ┗━━┻━━┛低地址
    75                              <1> ;
    76                              <1> 
    77                              <1> 
    78                              <1> ; 图示二
    79                              <1> 
    80                              <1> ; 高地址………………………………………………………………………低地址
    81                              <1> 
    82                              <1> ; |   7   |   6   |   5   |   4   |   3   |   2   |   1   |   0    |
    83                              <1> ; |7654321076543210765432107654321076543210765432107654321076543210|	<- 共 8 字节
    84                              <1> ; |--------========--------========--------========--------========|
    85                              <1> ; ┏━━━┳━━━━━━━┳━━━━━━━━━━━┳━━━━━━━┓
    86                              <1> ; ┃31..24┃   (见下图)   ┃     段基址(23..0)    ┃ 段界限(15..0)┃
    87                              <1> ; ┃      ┃              ┃                      ┃              ┃
    88                              <1> ; ┃ 基址2┃③│②│    ①┃基址1b│   基址1a     ┃    段界限1   ┃
    89                              <1> ; ┣━━━╋━━━┳━━━╋━━━━━━━━━━━╋━━━━━━━┫
    90                              <1> ; ┃   %6 ┃  %5  ┃  %4  ┃  %3  ┃     %2       ┃       %1     ┃
    91                              <1> ; ┗━━━┻━━━┻━━━┻━━━┻━━━━━━━┻━━━━━━━┛
    92                              <1> ;         │                \_________
    93                              <1> ;         │                          \__________________
    94                              <1> ;         │                                             \________________________________________________
    95                              <1> ;         │                                                                                              ;         ┏━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┓
    97                              <1> ;         ┃ 7  ┃ 6  ┃ 5  ┃ 4  ┃ 3  ┃ 2  ┃ 1  ┃ 0  ┃ 7  ┃ 6  ┃ 5  ┃ 4  ┃ 3  ┃ 2  ┃ 1  ┃ 0  ┃
    98                              <1> ;         ┣━━╋━━╋━━╋━━╋━━┻━━┻━━┻━━╋━━╋━━┻━━╋━━╋━━┻━━┻━━┻━━┫
    99                              <1> ;         ┃ G  ┃D/B ┃ 0  ┃ AVL┃   段界限 2 (19..16)  ┃  P ┃   DPL    ┃ S  ┃       TYPE           ┃
   100                              <1> ;         ┣━━┻━━┻━━┻━━╋━━━━━━━━━━━╋━━┻━━━━━┻━━┻━━━━━━━━━━━┫
   101                              <1> ;         ┃      ③: 属性 2      ┃    ②: 段界限 2      ┃                   ①: 属性1                  ┃
   102                              <1> ;         ┗━━━━━━━━━━━┻━━━━━━━━━━━┻━━━━━━━━━━━━━━━━━━━━━━━┛
   103                              <1> ;       高地址                                                                                          低地址
   104                              <1> ;
   105                              <1> ;
   106                              <1> 
   107                              <1> ; 说明:
   108                              <1> ;
   109                              <1> ; (1) P:    存在(Present)位。
   110                              <1> ;		P=1 表示描述符对地址转换是有效的，或者说该描述符所描述的段存在，即在内存中；
   111                              <1> ;		P=0 表示描述符对地址转换无效，即该段不存在。使用该描述符进行内存访问时会引起异常。
   112                              <1> ;
   113                              <1> ; (2) DPL:  表示描述符特权级(Descriptor Privilege level)，共2位。它规定了所描述段的特权级，用于特权检查，以决定对该段能否访问。 
   114                              <1> ;
   115                              <1> ; (3) S:   说明描述符的类型。
   116                              <1> ;		对于存储段描述符而言，S=1，以区别与系统段描述符和门描述符(S=0)。 
   117                              <1> ;
   118                              <1> ; (4) TYPE: 说明存储段描述符所描述的存储段的具体属性。
   119                              <1> ;
   120                              <1> ;		 
   121                              <1> ;	数据段类型	类型值		说明
   122                              <1> ;			----------------------------------
   123                              <1> ;			0		只读 
   124                              <1> ;			1		只读、已访问 
   125                              <1> ;			2		读/写 
   126                              <1> ;			3		读/写、已访问 
   127                              <1> ;			4		只读、向下扩展 
   128                              <1> ;			5		只读、向下扩展、已访问 
   129                              <1> ;			6		读/写、向下扩展 
   130                              <1> ;			7		读/写、向下扩展、已访问 
   131                              <1> ;
   132                              <1> ;		
   133                              <1> ;			类型值		说明
   134                              <1> ;	代码段类型	----------------------------------
   135                              <1> ;			8		只执行 
   136                              <1> ;			9		只执行、已访问 
   137                              <1> ;			A		执行/读 
   138                              <1> ;			B		执行/读、已访问 
   139                              <1> ;			C		只执行、一致码段 
   140                              <1> ;			D		只执行、一致码段、已访问 
   141                              <1> ;			E		执行/读、一致码段 
   142                              <1> ;			F		执行/读、一致码段、已访问 
   143                              <1> ;
   144                              <1> ;		
   145                              <1> ;	系统段类型	类型编码	说明
   146                              <1> ;			----------------------------------
   147                              <1> ;			0		<未定义>
   148                              <1> ;			1		可用286TSS
   149                              <1> ;			2		LDT
   150                              <1> ;			3		忙的286TSS
   151                              <1> ;			4		286调用门
   152                              <1> ;			5		任务门
   153                              <1> ;			6		286中断门
   154                              <1> ;			7		286陷阱门
   155                              <1> ;			8		未定义
   156                              <1> ;			9		可用386TSS
   157                              <1> ;			A		<未定义>
   158                              <1> ;			B		忙的386TSS
   159                              <1> ;			C		386调用门
   160                              <1> ;			D		<未定义>
   161                              <1> ;			E		386中断门
   162                              <1> ;			F		386陷阱门
   163                              <1> ;
   164                              <1> ; (5) G:    段界限粒度(Granularity)位。
   165                              <1> ;		G=0 表示界限粒度为字节；
   166                              <1> ;		G=1 表示界限粒度为4K 字节。
   167                              <1> ;           注意，界限粒度只对段界限有效，对段基地址无效，段基地址总是以字节为单位。 
   168                              <1> ;
   169                              <1> ; (6) D/B:  此位是一个很特殊的位，在描述可执行段、向下扩展数据段或由SS寄存器寻址的段(通常是堆栈段)的三种描述符中的意义各不相同。 
   170                              <1> ;           ⑴ 在描述可执行段的描述符中，D位决定了指令使用的地址及操作数所默认的大小。
   171                              <1> ;		① D=1表示默认情况下指令使用32位地址及32位或8位操作数，这样的代码段也称为32位代码段；
   172                              <1> ;		② D=0 表示默认情况下，使用16位地址及16位或8位操作数，这样的代码段也称为16位代码段，它与80286兼容。可以使用地址大小前缀和操作数大小前缀分别改变默认的地址或操作数的大小。 
   173                              <1> ;           ⑵ 在向下扩展数据段的描述符中，D位决定段的上部边界。
   174                              <1> ;		① D=1表示段的上部界限为4G；
   175                              <1> ;		② D=0表示段的上部界限为64K，这是为了与80286兼容。 
   176                              <1> ;           ⑶ 在描述由SS寄存器寻址的段描述符中，D位决定隐式的堆栈访问指令(如PUSH和POP指令)使用何种堆栈指针寄存器。
   177                              <1> ;		① D=1表示使用32位堆栈指针寄存器ESP；
   178                              <1> ;		② D=0表示使用16位堆栈指针寄存器SP，这与80286兼容。 
   179                              <1> ;
   180                              <1> ; (7) AVL:  软件可利用位。80386对该位的使用未左规定，Intel公司也保证今后开发生产的处理器只要与80386兼容，就不会对该位的使用做任何定义或规定。 
   181                              <1> ;
   182                              <1> 
   183                              <1> 
   184                              <1> ;----------------------------------------------------------------------------
   185                              <1> ; 描述符类型值说明
   186                              <1> ; 其中:
   187                              <1> ;       DA_  : Descriptor Attribute
   188                              <1> ;       D    : 数据段
   189                              <1> ;       C    : 代码段
   190                              <1> ;       S    : 系统段
   191                              <1> ;       R    : 只读
   192                              <1> ;       RW   : 读写
   193                              <1> ;       A    : 已访问
   194                              <1> ;       其它 : 可按照字面意思理解
   195                              <1> ;----------------------------------------------------------------------------
   196                              <1> DA_32		EQU	4000h	; 32 位段
   197                              <1> DA_4K   EQU 8000h ; 粒度为 4K
   198                              <1> 
   199                              <1> DA_DPL0		EQU	  00h	; DPL = 0
   200                              <1> DA_DPL1		EQU	  20h	; DPL = 1
   201                              <1> DA_DPL2		EQU	  40h	; DPL = 2
   202                              <1> DA_DPL3		EQU	  60h	; DPL = 3
   203                              <1> ;----------------------------------------------------------------------------
   204                              <1> ; 存储段描述符类型值说明
   205                              <1> ;----------------------------------------------------------------------------
   206                              <1> DA_DR		EQU	90h	; 存在的只读数据段类型值
   207                              <1> DA_DRW		EQU	92h	; 存在的可读写数据段属性值
   208                              <1> DA_DRWA		EQU	93h	; 存在的已访问可读写数据段类型值
   209                              <1> DA_DRWB   EQU 96h ;读写向下扩展的数据段
   210                              <1> DA_C		EQU	98h	; 存在的只执行代码段属性值
   211                              <1> DA_CR		EQU	9Ah	; 存在的可执行可读代码段属性值
   212                              <1> DA_CCO		EQU	9Ch	; 存在的只执行一致代码段属性值
   213                              <1> DA_CCOR		EQU	9Eh	; 存在的可执行可读一致代码段属性值
   214                              <1> ;----------------------------------------------------------------------------
   215                              <1> ; 系统段描述符类型值说明
   216                              <1> ;----------------------------------------------------------------------------
   217                              <1> DA_LDT		EQU	  82h	; 局部描述符表段类型值
   218                              <1> DA_TaskGate	EQU	  85h	; 任务门类型值
   219                              <1> DA_386TSS	EQU	  89h	; 可用 386 任务状态段类型值
   220                              <1> DA_386CGate	EQU	  8Ch	; 386 调用门类型值
   221                              <1> DA_386IGate	EQU	  8Eh	; 386 中断门类型值
   222                              <1> DA_386TGate	EQU	  8Fh	; 386 陷阱门类型值
   223                              <1> ;----------------------------------------------------------------------------
   224                              <1> 
   225                              <1> 
   226                              <1> ; 选择子图示:
   227                              <1> ;         ┏━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┳━━┓
   228                              <1> ;         ┃ 15 ┃ 14 ┃ 13 ┃ 12 ┃ 11 ┃ 10 ┃ 9  ┃ 8  ┃ 7  ┃ 6  ┃ 5  ┃ 4  ┃ 3  ┃ 2  ┃ 1  ┃ 0  ┃
   229                              <1> ;         ┣━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━┻━━╋━━╋━━┻━━┫
   230                              <1> ;         ┃                                 描述符索引                                 ┃ TI ┃   RPL    ┃
   231                              <1> ;         ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┻━━┻━━━━━┛
   232                              <1> ;
   233                              <1> ; RPL(Requested Privilege Level): 请求特权级，用于特权检查。
   234                              <1> ;
   235                              <1> ; TI(Table Indicator): 引用描述符表指示位
   236                              <1> ;	TI=0 指示从全局描述符表GDT中读取描述符；
   237                              <1> ;	TI=1 指示从局部描述符表LDT中读取描述符。
   238                              <1> ;
   239                              <1> 
   240                              <1> ;----------------------------------------------------------------------------
   241                              <1> ; 选择子类型值说明
   242                              <1> ; 其中:
   243                              <1> ;       SA_  : Selector Attribute
   244                              <1> 
   245                              <1> SA_RPL0		EQU	0	; ┓
   246                              <1> SA_RPL1		EQU	1	; ┣ RPL
   247                              <1> SA_RPL2		EQU	2	; ┃
   248                              <1> SA_RPL3		EQU	3	; ┛
   249                              <1> 
   250                              <1> SA_TIG		EQU	0	; ┓TI
   251                              <1> SA_TIL		EQU	4	; ┛
   252                              <1> ;----------------------------------------------------------------------------
   253                              <1> 
   254                              <1> 
   255                              <1> 
   256                              <1> 
   257                              <1> 
   258                              <1> ; 宏 ------------------------------------------------------------------------------------------------------
   259                              <1> ;
   260                              <1> ; 描述符
   261                              <1> ; usage: Descriptor Base, Limit, Attr
   262                              <1> ;        Base:  dd
   263                              <1> ;        Limit: dd (low 20 bits available)
   264                              <1> ;        Attr:  dw (lower 4 bits of higher byte are always 0)
   265                              <1> %macro Descriptor 3
   266                              <1> 	dw	%2 & 0FFFFh				; 段界限 1				(2 字节)
   267                              <1> 	dw	%1 & 0FFFFh				; 段基址 1				(2 字节)
   268                              <1> 	db	(%1 >> 16) & 0FFh			; 段基址 2				(1 字节)
   269                              <1> 	dw	((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)	; 属性 1 + 段界限 2 + 属性 2		(2 字节)
   270                              <1> 	db	(%1 >> 24) & 0FFh			; 段基址 3				(1 字节)
   271                              <1> %endmacro ; 共 8 字节
   272                              <1> ;
   273                              <1> ; 门
   274                              <1> ; usage: Gate Selector, Offset, DCount, Attr
   275                              <1> ;        Selector:  dw
   276                              <1> ;        Offset:    dd
   277                              <1> ;        DCount:    db
   278                              <1> ;        Attr:      db
   279                              <1> %macro Gate 4
   280                              <1> 	dw	(%2 & 0FFFFh)				; 偏移 1				(2 字节)
   281                              <1> 	dw	%1					; 选择子				(2 字节)
   282                              <1> 	dw	(%3 & 1Fh) | ((%4 << 8) & 0FF00h)	; 属性					(2 字节)
   283                              <1> 	dw	((%2 >> 16) & 0FFFFh)			; 偏移 2				(2 字节)
   284                              <1> %endmacro ; 共 8 字节
   285                              <1> ; ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
     4                                  ;-------------------------------------------------------------------------------
     5                                           core_base_address equ 0x00040000   ;ں˼صʼڴַ 
     6                                           core_start_sector equ 0x00000001   ;ں˵ʼ߼
     7                                  
     8                                  ;GDT Begin                            λַ          ν            
     9                                  LABEL_GDT:             Descriptor          0,              0,              0           ; 
     9                              <1> LABEL_GDT: 
   266 00000000 0000                <1>  dw %2 & 0FFFFh
   267 00000002 0000                <1>  dw %1 & 0FFFFh
   268 00000004 00                  <1>  db (%1 >> 16) & 0FFh
   269 00000005 0000                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   270 00000007 00                  <1>  db (%1 >> 24) & 0FFh
    10                                  LABEL_DESC_DATA:       Descriptor         0,        0xFFFFF,         DA_DRW+DA_4K+DA_32     ;Ϊ4K洢
    10                              <1> LABEL_DESC_DATA: 
   266 00000008 FFFF                <1>  dw %2 & 0FFFFh
   267 0000000A 0000                <1>  dw %1 & 0FFFFh
   268 0000000C 00                  <1>  db (%1 >> 16) & 0FFh
   269 0000000D 92CF                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   270 0000000F 00                  <1>  db (%1 >> 24) & 0FFh
    11                                  LABEL_DESC_CODE:       Descriptor    0x7c00,         0x01FF,         DA_C+DA_32
    11                              <1> LABEL_DESC_CODE: 
   266 00000010 FF01                <1>  dw %2 & 0FFFFh
   267 00000012 007C                <1>  dw %1 & 0FFFFh
   268 00000014 00                  <1>  db (%1 >> 16) & 0FFh
   269 00000015 9840                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   270 00000017 00                  <1>  db (%1 >> 24) & 0FFh
    12                                  LABEL_DESC_STACK:      Descriptor    0x7c00,        0xFFFFE,         DA_4K+DA_DRWB+DA_32   
    12                              <1> LABEL_DESC_STACK: 
   266 00000018 FEFF                <1>  dw %2 & 0FFFFh
   267 0000001A 007C                <1>  dw %1 & 0FFFFh
   268 0000001C 00                  <1>  db (%1 >> 16) & 0FFh
   269 0000001D 96CF                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   270 0000001F 00                  <1>  db (%1 >> 24) & 0FFh
    13                                  LABEL_DESC_VIDEO:      Descriptor   0xb8000,        0x07FFF,         DA_DRW+DA_32 
    13                              <1> LABEL_DESC_VIDEO: 
   266 00000020 FF7F                <1>  dw %2 & 0FFFFh
   267 00000022 0080                <1>  dw %1 & 0FFFFh
   268 00000024 0B                  <1>  db (%1 >> 16) & 0FFh
   269 00000025 9240                <1>  dw ((%2 >> 8) & 0F00h) | (%3 & 0F0FFh)
   270 00000027 00                  <1>  db (%1 >> 24) & 0FFh
    14                                  ;GDT End
    15                                  GtdLen  equ $ - LABEL_GDT
    16 00000028 2700                    GdtPtr  dw GtdLen - 1
    17 0000002A 00000000                        dd 0
    18                                  ;-------------------------------------------------------------------------------         
    19                                           ;GDTڵ߼εַ
    20 0000002E 668CC8                           mov eax,cs      ;GDT32λַ 
    21 00000031 6631D2                           xor edx,edx
    22 00000034 66BB10000000                     mov ebx,16
    23 0000003A 66F7F3                           div ebx                            ;ֽ16λ߼ַ 
    24                                  
    25 0000003D 8ED8                             mov ds,eax                         ;DSָöԽв
    26 0000003F 6689D3                           mov ebx,edx                        ;ʼƫƵַ 
    27                                   
    28 00000042 2E66A3[2A00]                     mov [cs:GdtPtr+2],eax
    29 00000047 2E0F0116[287C]                   lgdt [cs: GdtPtr+0x7c00]
    30                                        
    31 0000004D E492                             in al,0x92                         ;оƬڵĶ˿ 
    32 0000004F 0C02                             or al,0000_0010B
    33 00000051 E692                             out 0x92,al                        ;A20
    34                                  
    35 00000053 FA                               cli                                ;жϻδ
    36                                  
    37 00000054 0F20C0                           mov eax,cr0
    38 00000057 6683C801                         or eax,1
    39 0000005B 0F22C0                           mov cr0,eax                        ;PEλ
    40                                        
    41                                           ;½뱣ģʽ... ...
    42 0000005E EA[6300]1000                     jmp 0x0010:flush                   ;ˮ߲л
    43                                  
    44                                           [bits 32]               
    45                                    flush:                                  
    46 00000063 B808000000                       mov eax,0x0008                     ;ݶ(0..4GB)ѡ
    47 00000068 8ED8                             mov ds,eax
    48                                  
    49 0000006A B818000000                       mov eax,0x0018                     ;ضջѡ 
    50 0000006F 8ED0                             mov ss,eax
    51 00000071 31E4                             xor esp,esp                        ;ջָ <- 0 
    52                                  
    53                                           ;¼ϵͳĳ 
    54 00000073 BF00000400                       mov edi,core_base_address 
    55                                        
    56 00000078 B801000000                       mov eax,core_start_sector
    57 0000007D 89FB                             mov ebx,edi                        ;ʼַ 
    58 0000007F E88D000000                       call read_hard_disk_0              ;¶ȡʼ֣һ 
    59                                        
    60                                           ;жж
    61 00000084 8B07                             mov eax,[edi]                      ;ĳߴ
    62 00000086 31D2                             xor edx,edx 
    63 00000088 B900020000                       mov ecx,512                        ;512ֽÿ
    64 0000008D F7F1                             div ecx
    65                                  
    66 0000008F 09D2                             or edx,edx
    67 00000091 7501                             jnz @1                             ;δ˽ʵ1 
    68 00000093 48                               dec eax                            ;Ѿһ1 
    69                                     @1:
    70 00000094 09C0                             or eax,eax                         ;ʵʳȡ512ֽڵ 
    71 00000096 7410                             jz setup                           ;EAX=0 ?
    72                                  
    73                                           ;ȡʣ
    74 00000098 89C1                             mov ecx,eax                        ;32λģʽµLOOPʹECX
    75 0000009A B801000000                       mov eax,core_start_sector
    76 0000009F 40                               inc eax                            ;һ߼Ŷ
    77                                     @2:
    78 000000A0 E86C000000                       call read_hard_disk_0
    79 000000A5 40                               inc eax
    80 000000A6 E2F8                             loop @2                            ;ѭֱں 
    81                                  
    82                                   setup:
    83 000000A8 8B35[737D0000]                   mov esi,[0x7c00+pgdt+0x02]         ;ڴѰַpgdt
    84                                                                              ;ͨ4GBĶ
    85                                           ;̶
    86 000000AE 8B4704                           mov eax,[edi+0x04]                 ;̴ʼַ
    87 000000B1 8B5F08                           mov ebx,[edi+0x08]                 ;ݶλַ
    88 000000B4 29C3                             sub ebx,eax
    89 000000B6 4B                               dec ebx                            ;̶ν 
    90 000000B7 01F8                             add eax,edi                        ;̶λַ
    91 000000B9 B900984000                       mov ecx,0x00409800                 ;ֽȵĴ
    92 000000BE E893000000                       call make_gdt_descriptor
    93 000000C3 894628                           mov [esi+0x28],eax
    94 000000C6 89562C                           mov [esi+0x2c],edx
    95                                         
    96                                           ;ݶ
    97 000000C9 8B4708                           mov eax,[edi+0x08]                 ;ݶʼַ
    98 000000CC 8B5F0C                           mov ebx,[edi+0x0c]                 ;Ĵλַ 
    99 000000CF 29C3                             sub ebx,eax
   100 000000D1 4B                               dec ebx                            ;ݶν
   101 000000D2 01F8                             add eax,edi                        ;ݶλַ
   102 000000D4 B900924000                       mov ecx,0x00409200                 ;ֽȵݶ 
   103 000000D9 E878000000                       call make_gdt_descriptor
   104 000000DE 894630                           mov [esi+0x30],eax
   105 000000E1 895634                           mov [esi+0x34],edx 
   106                                        
   107                                           ;Ĵ
   108 000000E4 8B470C                           mov eax,[edi+0x0c]                 ;Ĵʼַ
   109 000000E7 8B1F                             mov ebx,[edi+0x00]                 ;ܳ
   110 000000E9 29C3                             sub ebx,eax
   111 000000EB 4B                               dec ebx                            ;Ĵν
   112 000000EC 01F8                             add eax,edi                        ;Ĵλַ
   113 000000EE B900984000                       mov ecx,0x00409800                 ;ֽȵĴ
   114 000000F3 E85E000000                       call make_gdt_descriptor
   115 000000F8 894638                           mov [esi+0x38],eax
   116 000000FB 89563C                           mov [esi+0x3c],edx
   117                                  
   118 000000FE 66C705[717D0000]3F-              mov word [0x7c00+pgdt],63          ;Ľ
   118 00000106 00                 
   119                                                                          
   120 00000107 0F0115[717D0000]                 lgdt [0x7c00+pgdt]                  
   121                                  
   122 0000010E FF6F10                           jmp far [edi+0x10]  
   123                                         
   124                                  ;-------------------------------------------------------------------------------
   125                                  read_hard_disk_0:                        ;Ӳ̶ȡһ߼
   126                                                                           ;EAX=߼
   127                                                                           ;DS:EBX=Ŀ껺ַ
   128                                                                           ;أEBX=EBX+512 
   129 00000111 50                               push eax 
   130 00000112 51                               push ecx
   131 00000113 52                               push edx
   132                                        
   133 00000114 50                               push eax
   134                                           
   135 00000115 66BAF201                         mov dx,0x1f2
   136 00000119 B001                             mov al,1
   137 0000011B EE                               out dx,al                       ;ȡ
   138                                  
   139 0000011C 6642                             inc dx                          ;0x1f3
   140 0000011E 58                               pop eax
   141 0000011F EE                               out dx,al                       ;LBAַ7~0
   142                                  
   143 00000120 6642                             inc dx                          ;0x1f4
   144 00000122 B108                             mov cl,8
   145 00000124 D3E8                             shr eax,cl
   146 00000126 EE                               out dx,al                       ;LBAַ15~8
   147                                  
   148 00000127 6642                             inc dx                          ;0x1f5
   149 00000129 D3E8                             shr eax,cl
   150 0000012B EE                               out dx,al                       ;LBAַ23~16
   151                                  
   152 0000012C 6642                             inc dx                          ;0x1f6
   153 0000012E D3E8                             shr eax,cl
   154 00000130 0CE0                             or al,0xe0                      ;һӲ  LBAַ27~24
   155 00000132 EE                               out dx,al
   156                                  
   157 00000133 6642                             inc dx                          ;0x1f7
   158 00000135 B020                             mov al,0x20                     ;
   159 00000137 EE                               out dx,al
   160                                  
   161                                    .waits:
   162 00000138 EC                               in al,dx
   163 00000139 2488                             and al,0x88
   164 0000013B 3C08                             cmp al,0x08
   165 0000013D 75F9                             jnz .waits                      ;æӲ׼ݴ 
   166                                  
   167 0000013F B900010000                       mov ecx,256                     ;ܹҪȡ
   168 00000144 66BAF001                         mov dx,0x1f0
   169                                    .readw:
   170 00000148 66ED                             in ax,dx
   171 0000014A 668903                           mov [ebx],ax
   172 0000014D 83C302                           add ebx,2
   173 00000150 E2F6                             loop .readw
   174                                  
   175 00000152 5A                               pop edx
   176 00000153 59                               pop ecx
   177 00000154 58                               pop eax
   178                                        
   179 00000155 C3                               ret
   180                                  
   181                                  ;-------------------------------------------------------------------------------
   182                                  make_gdt_descriptor:                     ;
   183                                                                           ;룺EAX=Իַ
   184                                                                           ;      EBX=ν
   185                                                                           ;      ECX=ԣλԭʼ
   186                                                                           ;      λãûõλ0 
   187                                                                           ;أEDX:EAX=
   188 00000156 89C2                             mov edx,eax
   189 00000158 C1E010                           shl eax,16                     
   190 0000015B 6609D8                           or ax,bx                        ;ǰ32λ(EAX)
   191                                        
   192 0000015E 81E20000FFFF                     and edx,0xffff0000              ;ַ޹صλ
   193 00000164 C1C208                           rol edx,8
   194 00000167 0FCA                             bswap edx                       ;װַ31~2423~16  (80486+)
   195                                        
   196 00000169 6631DB                           xor bx,bx
   197 0000016C 09DA                             or edx,ebx                      ;װν޵ĸ4λ
   198                                        
   199 0000016E 09CA                             or edx,ecx                      ;װ 
   200                                        
   201 00000170 C3                               ret
   202                                        
   203                                  ;-------------------------------------------------------------------------------
   204 00000171 0000                             pgdt             dw 0
   205 00000173 007E0000                                          dd 0x00007e00      ;GDTַ
   206                                  ;-------------------------------------------------------------------------------                             
   207 00000177 00<rep 87h>                      times 510-($-$$) db 0
   208 000001FE 55AA                                              db 0x55,0xaa
